# CLI Reference

## pei-docker-cli

**Usage:** `pei-docker-cli [OPTIONS] COMMAND [ARGS]...`

**Note:** If working in a Pixi-managed project, use `pixi run pei-docker-cli`. If installed globally (e.g., via `uv tool install`), use `pei-docker-cli` directly.

### Commands

| Command | Description |
| --- | --- |
| `create` | Create new project |
| `configure` | Generate docker-compose.yml from user_config.yml |
| `remove` | Remove Docker images and containers |

### create

Creates new PeiDocker project with template files.

**Options:**
- `-p, --project-dir DIRECTORY` - Project directory (required)
- `-e, --with-examples` - Include example files (default: enabled)

**Examples:**
```bash
# Create with all files
pei-docker-cli create -p ./my-project

# Minimal project
pei-docker-cli create -p ./minimal --no-with-examples
```

### configure

Generates docker-compose.yml and Dockerfiles from user_config.yml.

**Options:**
- `-p, --project-dir DIRECTORY` - Project directory (default: current)
- `-c, --config FILE` - Config file name (default: user_config.yml)
- `--with-merged` - Generate standalone merged build artifacts (merged.Dockerfile, etc.)

**Examples:**
```bash
# Use current directory
pei-docker-cli configure

# Specify directory
pei-docker-cli configure -p ./my-project

# Generate merged build artifacts (for building without docker compose)
pei-docker-cli configure --with-merged
```

## Merged Build Scripts

When running `configure --with-merged`, the following scripts are generated:

### build-merged.sh
One-shot build script that sources `merged.env` and runs `docker build`.

**Options:**
- `-o, --output-image <name:tag>`: Override output image tag.
- `--`: Pass additional flags directly to `docker build`.

**Example:**
```bash
./build-merged.sh -o myorg/myapp:dev -- --no-cache
```

### run-merged.sh
Convenience runner that reads defaults from `merged.env`.

**Options:**
- `-n, --name <name>`: Container name.
- `-d`: Detach mode.
- `--gpus all`: Enable GPUs.
- `--`: Command to run inside container.

**Example:**
```bash
./run-merged.sh -d -p 8080:8080 --gpus all
```

## Project Structure

After running `pei-docker-cli create` and `configure`, your project directory will look like this:

```
project_dir/
├── user_config.yml         # Main configuration file (EDIT THIS)
├── docker-compose.yml      # Generated by configure command (DO NOT EDIT)
├── stage-1.Dockerfile      # Generated stage-1 Dockerfile
├── stage-2.Dockerfile      # Generated stage-2 Dockerfile
├── installation/           # Directory copied into the container image
│   ├── stage-1/            # Stage-1 resources
│   │   ├── custom/         # Place your custom stage-1 scripts here
│   │   └── system/         # System config scripts (apt, ssh, etc.)
│   └── stage-2/            # Stage-2 resources
│       ├── custom/         # Place your custom stage-2 scripts here
│       └── system/         # Application setup scripts
├── examples/               # Reference configurations (if --with-examples used)
├── build-merged.sh         # (Optional) Standalone build script
├── run-merged.sh           # (Optional) Standalone run script
└── merged.Dockerfile       # (Optional) Unified Dockerfile for merged builds
```

### Key Directories

*   **`installation/stage-X/custom/`**: This is where you put your own shell scripts.
    *   Refer to these in `user_config.yml` under `custom: on_build: - stage-X/custom/myscript.sh`.
*   **`installation/stage-X/system/`**: Contains PeiDocker's internal setup scripts. Useful for reference but generally shouldn't be modified.
